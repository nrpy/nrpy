"""
Set up C function library for SEOBNR initial conditions.

Authors: Siddharth Mahesh
        sm0193 **at** mix **dot** wvu **dot** edu
        Suchindram Dasgupta
        sd00113 **at** mix **dot** wvu **dot** edu
        Zachariah B. Etienne
        zachetie **at** gmail **dot* com
"""

from inspect import currentframe as cfr
from types import FrameType as FT
from typing import Union, cast

import nrpy.c_codegen as ccg
import nrpy.c_function as cfc
import nrpy.equations.seobnr.SEOBNRv5_aligned_spin_constants as SEOBNRv5_const
import nrpy.helpers.parallel_codegen as pcg
import nrpy.params as par


def register_CFunction_SEOBNRv5_aligned_spin_coefficients(
    calibration_no_spin: bool = False,
    calibration_spin: bool = False,
) -> Union[None, pcg.NRPyEnv_type]:
    """
    Register CFunction for evaluating the masses and SEOBNRv5 coefficients.
    The inputs needed to generate an EOB approximant are mass ratio, spins and
    an initial orbital frequency. Therefore, one needs to compute the individual
    masses from the mass ratio and the Hamiltonian coefficients which are a function
    of mass ratio and spins. The Hamiltonian calibration coefficients can be pre-computed
    or added to the parfile for calibrating the SEOBNRv5 approximant.

    :param calibration_no_spin: If True, the non-spinning calibration coefficients are added to the parfile.
                                pySEOBNR v5 calibration coefficients are used if False.
    :param calibration_spin: If True, the spin-dependent calibration coefficients are added to the parfile.
                                pySEOBNR v5 calibration coefficients are used if False.
    :raises ValueError: If both calibration_no_spin and calibration_spin are True.
    :return: None if in registration phase, else the updated NRPy environment.
    """
    # The calibration process for the SEOBNRv5 is done in two steps:
    # 1. Calibration of the non-spinning coefficients
    # 2. Calibration of the spin-dependent coefficients
    # Therefore, the C code can only be generated for one of the above calibration options.
    if calibration_no_spin and calibration_spin:
        raise ValueError(
            "calibration_no_spin and calibration_spin cannot both be True."
        )
    if pcg.pcg_registration_phase():
        pcg.register_func_call(f"{__name__}.{cast(FT, cfr()).f_code.co_name}", locals())
        return None

    # Needed during integration and derived from other quantities; do not set!
    par.register_CodeParameters(
        "REAL",
        __name__,
        [
            "r",
            "phi",
            "m1",
            "m2",
            "prstar",
            "pphi",
            "t_stepback",
        ],
        [
            20,
            0,
            0.5,
            0.5,
            0.0,
            3.3,
            250.0,
        ],  # r, phi, m1, m2, prstar, pphi
        commondata=True,
        add_to_parfile=False,
    )

    # Define lists of parameter names for robust registration.
    base_param_names = [
        "Delta_t",
        "dT",
        "t_ISCO",
        "t_attach",
        "omega_qnm",
        "tau_qnm",
        "a_f",
        "M_f",
        "nr_amp_1",
        "nr_amp_2",
        "nr_amp_3",
        "nr_omega_1",
        "nr_omega_2",
        "a_1_NQC",
        "a_2_NQC",
        "a_3_NQC",
        "b_1_NQC",
        "b_2_NQC",
        "r_stop",
        "r_ISCO",
    ]
    qnm_param_names = [
        "omega_qnm_l2m2",
        "tau_qnm_l2m2",
        "omega_qnm_l2m1",
        "tau_qnm_l2m1",
        "omega_qnm_l3m3",
        "tau_qnm_l3m3",
        "omega_qnm_l3m2",
        "tau_qnm_l3m2",
        "omega_qnm_l4m4",
        "tau_qnm_l4m4",
        "omega_qnm_l4m3",
        "tau_qnm_l4m3",
        "omega_qnm_l5m5",
        "tau_qnm_l5m5",
    ]
    all_param_names = base_param_names + qnm_param_names
    par.register_CodeParameters(
        "REAL",
        __name__,
        all_param_names,
        [0.0] * len(all_param_names),
        commondata=True,
        add_to_parfile=False,
    )

    # Register the calibration coefficients conditionally
    if calibration_no_spin:
        par.register_CodeParameters(
            "REAL",
            __name__,
            ["Delta_t_NS", "a6"],
            [0.0, 0.0],
            commondata=True,
            add_to_parfile=True,
        )
        par.register_CodeParameters(
            "REAL",
            __name__,
            ["Delta_t_S", "dSO"],
            [0.0, 0.0],
            commondata=True,
            add_to_parfile=False,
        )
    elif calibration_spin:
        par.register_CodeParameters(
            "REAL",
            __name__,
            ["Delta_t_NS", "a6"],
            [0.0, 0.0],
            commondata=True,
            add_to_parfile=False,
        )
        par.register_CodeParameters(
            "REAL",
            __name__,
            ["Delta_t_S", "dSO"],
            [0.0, 0.0],
            commondata=True,
            add_to_parfile=True,
        )
    else:
        par.register_CodeParameters(
            "REAL",
            __name__,
            ["a6", "dSO"],
            [0.0, 0.0],
            commondata=True,
            add_to_parfile=False,
        )

    par.register_CodeParameters(
        "REAL *restrict",
        __name__,
        ["dynamics_low", "dynamics_fine", "dynamics_raw"],
        commondata=True,
        add_to_parfile=False,
        add_to_set_CodeParameters_h=False,
    )

    par.register_CodeParameters(
        "double complex *restrict",
        __name__,
        ["waveform_low", "waveform_fine", "waveform_inspiral", "waveform_IMR"],
        commondata=True,
        add_to_parfile=False,
        add_to_set_CodeParameters_h=False,
    )

    par.register_CodeParameters(
        "size_t",
        __name__,
        ["nsteps_raw", "nsteps_low", "nsteps_fine", "nsteps_inspiral", "nsteps_IMR"],
        commondata=True,
        add_to_parfile=False,
        add_to_set_CodeParameters_h=False,
    )

    par.register_CodeParameters(
        "REAL",
        __name__,
        [
            "dHreal_dr",
            "dHreal_dprstar",
            "dHreal_dpphi",
            "dHreal_dr_dr",
            "dHreal_dr_dpphi",
            "dHreal_dr_circ",
            "dHreal_dpphi_circ",
            "Hreal",
            "xi",
            "flux",
            "Omega_circ",
        ],
        commondata=True,
        add_to_parfile=False,
    )

    par.register_CodeParameters(
        "REAL",
        __name__,
        ["mass_ratio", "chi1", "chi2", "initial_omega", "total_mass", "dt"],
        [1, 0.4, -0.3, 0.01118, 50, 2.4627455127717882e-05],
        commondata=True,
        add_to_parfile=True,
    )

    # register the calibration coefficients
    if calibration_no_spin:
        par.register_CodeParameters(
            "REAL",
            __name__,
            [
                "Delta_t_NS",
                "a6",
            ],
            [
                0.0,
                0.0,
            ],
            commondata=True,
            add_to_parfile=True,
        )
        par.register_CodeParameters(
            "REAL",
            __name__,
            [
                "Delta_t_S",
                "dSO",
            ],
            [
                0.0,
                0.0,
            ],
            commondata=True,
            add_to_parfile=False,
        )
    elif calibration_spin:
        par.register_CodeParameters(
            "REAL",
            __name__,
            [
                "Delta_t_NS",
                "a6",
            ],
            [
                0.0,
                0.0,
            ],
            commondata=True,
            add_to_parfile=False,
        )
        par.register_CodeParameters(
            "REAL",
            __name__,
            [
                "Delta_t_S",
                "dSO",
            ],
            [
                0.0,
                0.0,
            ],
            commondata=True,
            add_to_parfile=True,
        )
    else:
        par.register_CodeParameters(
            "REAL",
            __name__,
            [
                "a6",
                "dSO",
            ],
            [
                0.0,
                0.0,
            ],
            commondata=True,
            add_to_parfile=False,
        )
    # We must include gsl/gsl_spline.h for the QNM interpolation
    includes = ["BHaH_defines.h", "gsl/gsl_spline.h"]

    desc = """
Evaluate and store the SEOBNRv5 calibration coefficients and remnant properties.

@param commondata - The Common data structure containing the model parameters.
"""
    cfunc_type = "void"
    name = "SEOBNRv5_aligned_spin_coefficients"
    params = "commondata_struct *restrict commondata"
    v5_const = SEOBNRv5_const.SEOBNR_aligned_spin_constants(
        calibration_no_spin, calibration_spin
    )
    body = """
REAL q = commondata->mass_ratio;
REAL eta = q / (1.0 + q) / (1.0 + q);
// Ensure eta is consistent if we snap q to 1.0
if (eta > 0.25){
  if (fabs(q - 1.) < 1e-13){
    q = 1.;
    eta = 0.25;
  } else {
    printf("mass ratio = %.15e causes eta = %.15e > 0.25\\n",q,eta);
    exit(EXIT_FAILURE);
  }
}
commondata->m1 = q / (1.0 + q);
commondata->m2 = 1.0 / (1.0 + q);
const REAL m1 = commondata->m1;
const REAL m2 = commondata->m2;
const REAL chi1 = commondata->chi1;
const REAL chi2 = commondata->chi2;
commondata->dT = commondata->dt / commondata->total_mass / 4.925490947641266978197229498498379006e-6;
"""
    if calibration_no_spin:
        body += """
const REAL Delta_t_NS = commondata->Delta_t_NS;
"""
        body += ccg.c_codegen(
            [
                v5_const.Delta_t,
                v5_const.M_f,
                v5_const.a_f,
                v5_const.rISCO,
                v5_const.rstop,
            ],
            [
                "commondata->Delta_t",
                "commondata->M_f",
                "commondata->a_f",
                "commondata->r_ISCO",
                "commondata->r_stop",
            ],
            verbose=False,
            include_braces=False,
        )
    elif calibration_spin:
        body += """
const REAL Delta_t_S = commondata->Delta_t_S;
"""
        body += ccg.c_codegen(
            [
                v5_const.pyseobnr_a6,
                v5_const.Delta_t,
                v5_const.M_f,
                v5_const.a_f,
                v5_const.rISCO,
                v5_const.rstop,
            ],
            [
                "commondata->a6",
                "commondata->Delta_t",
                "commondata->M_f",
                "commondata->a_f",
                "commondata->r_ISCO",
                "commondata->r_stop",
            ],
            verbose=False,
            include_braces=False,
        )
    else:
        body += ccg.c_codegen(
            [
                v5_const.pyseobnr_a6,
                v5_const.pyseobnr_dSO,
                v5_const.Delta_t,
                v5_const.M_f,
                v5_const.a_f,
                v5_const.rISCO,
                v5_const.rstop,
            ],
            [
                "commondata->a6",
                "commondata->dSO",
                "commondata->Delta_t",
                "commondata->M_f",
                "commondata->a_f",
                "commondata->r_ISCO",
                "commondata->r_stop",
            ],
            verbose=False,
            include_braces=False,
        )
    body += """
const REAL afinallist[107] = { -0.9996, -0.9995, -0.9994, -0.9992, -0.999, -0.9989, -0.9988,
  -0.9987, -0.9986, -0.9985, -0.998, -0.9975, -0.997, -0.996, -0.995, -0.994, -0.992, -0.99, -0.988,
  -0.986, -0.984, -0.982, -0.98, -0.975, -0.97, -0.96, -0.95, -0.94, -0.92, -0.9, -0.88, -0.86, -0.84,
  -0.82, -0.8, -0.78, -0.76, -0.74, -0.72, -0.7, -0.65, -0.6, -0.55, -0.5, -0.45, -0.4, -0.35, -0.3,
  -0.25, -0.2, -0.15, -0.1, -0.05, 0., 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6,
  0.65, 0.7, 0.72, 0.74, 0.76, 0.78, 0.8, 0.82, 0.84, 0.86, 0.88, 0.9, 0.92, 0.94, 0.95, 0.96, 0.97,
  0.975, 0.98, 0.982, 0.984, 0.986, 0.988, 0.99, 0.992, 0.994, 0.995, 0.996, 0.997, 0.9975, 0.998,
  0.9985, 0.9986, 0.9987, 0.9988, 0.9989, 0.999, 0.9992, 0.9994, 0.9995, 0.9996
};

// NOTE: imomegaqnm_* tables store the positive damping rate |Im(Ï‰)|.
const REAL reomegaqnm_l2m2[107] = {
  0.2915755, 0.2915810, 0.2915866, 0.2915976, 0.2916086, 0.2916142, 0.2916197, 0.2916252,
  0.2916307, 0.2916362, 0.2916638, 0.2916915, 0.2917191, 0.2917744, 0.2918297, 0.2918850,
  0.2919958, 0.2921067, 0.2922178, 0.2923289, 0.2924403, 0.2925517, 0.2926633, 0.2929430,
  0.2932235, 0.2937871, 0.2943542, 0.2949249, 0.2960772, 0.2972442, 0.2984264, 0.2996240,
  0.3008375, 0.3020672, 0.3033134, 0.3045767, 0.3058573, 0.3071558, 0.3084726, 0.3098081,
  0.3132321, 0.3167840, 0.3204726, 0.3243073, 0.3282986, 0.3324579, 0.3367980, 0.3413329,
  0.3460786, 0.3510526, 0.3562748, 0.3617677, 0.3675569, 0.3736717, 0.3801456, 0.3870175,
  0.3943330, 0.4021453, 0.4105179, 0.4195267, 0.4292637, 0.4398419, 0.4514022, 0.4641230,
  0.4782352, 0.4940448, 0.5119692, 0.5326002, 0.5417937, 0.5516303, 0.5622007, 0.5736164,
  0.5860170, 0.5995803, 0.6145391, 0.6312060, 0.6500179, 0.6716143, 0.6969947, 0.7278753,
  0.7463200, 0.7676741, 0.7932082, 0.8082349, 0.8254295, 0.8331001, 0.8413428, 0.8502722,
  0.8600462, 0.8708927, 0.8831622, 0.8974463, 0.9056637, 0.9149017, 0.9255811, 0.9316886,
  0.9385236, 0.9463846, 0.9481225, 0.9499294, 0.9518133, 0.9537843, 0.9558544, 0.9603582,
  0.9655139, 0.9684383, 0.9716904
};

const REAL imomegaqnm_l2m2[107] = {
  0.0880269, 0.0880272, 0.0880274, 0.0880280, 0.0880285, 0.0880288, 0.0880290, 0.0880293,
  0.0880296, 0.0880298, 0.0880311, 0.0880325, 0.0880338, 0.0880364, 0.0880391, 0.0880417,
  0.0880470, 0.0880523, 0.0880575, 0.0880628, 0.0880680, 0.0880733, 0.0880785, 0.0880915,
  0.0881045, 0.0881304, 0.0881560, 0.0881813, 0.0882315, 0.0882807, 0.0883289, 0.0883763,
  0.0884226, 0.0884679, 0.0885122, 0.0885555, 0.0885976, 0.0886386, 0.0886785, 0.0887172,
  0.0888085, 0.0888917, 0.0889663, 0.0890315, 0.0890868, 0.0891313, 0.0891643, 0.0891846,
  0.0891911, 0.0891825, 0.0891574, 0.0891138, 0.0890496, 0.0889623, 0.0888489, 0.0887057,
  0.0885283, 0.0883112, 0.0880477, 0.0877293, 0.0873453, 0.0868820, 0.0863212, 0.0856388,
  0.0848021, 0.0837652, 0.0824618, 0.0807929, 0.0799908, 0.0790927, 0.0780817, 0.0769364,
  0.0756296, 0.0741258, 0.0723780, 0.0703215, 0.0678642, 0.0648692, 0.0611186, 0.0562313,
  0.0531490, 0.0494336, 0.0447904, 0.0419586, 0.0386302, 0.0371155, 0.0354676, 0.0336590,
  0.0316516, 0.0293904, 0.0267908, 0.0237095, 0.0219107, 0.0198661, 0.0174737, 0.0160919,
  0.0145340, 0.0127274, 0.0123259, 0.0119077, 0.0114708, 0.0110127, 0.0105306, 0.0094780,
  0.0082669, 0.0075770, 0.0068074
};

const REAL reomegaqnm_l2m1[107] = {
  0.3438626, 0.3438628, 0.3438631, 0.3438636, 0.3438642, 0.3438644, 0.3438647, 0.3438649,
  0.3438652, 0.3438655, 0.3438668, 0.3438681, 0.3438695, 0.3438722, 0.3438750, 0.3438778,
  0.3438837, 0.3438896, 0.3438958, 0.3439022, 0.3439087, 0.3439155, 0.3439224, 0.3439406,
  0.3439599, 0.3440022, 0.3440494, 0.3441014, 0.3442201, 0.3443587, 0.3445174, 0.3446963,
  0.3448956, 0.3451154, 0.3453558, 0.3456169, 0.3458988, 0.3462015, 0.3465251, 0.3468698,
  0.3478237, 0.3489107, 0.3501325, 0.3514914, 0.3529902, 0.3546326, 0.3564229, 0.3583663,
  0.3604691, 0.3627384, 0.3651827, 0.3678118, 0.3706371, 0.3736717, 0.3769308, 0.3804323,
  0.3841965, 0.3882478, 0.3926145, 0.3973304, 0.4024357, 0.4079791, 0.4140201, 0.4206324,
  0.4279088, 0.4359685, 0.4449684, 0.4551215, 0.4595687, 0.4642715, 0.4692586, 0.4745645,
  0.4802307, 0.4863080, 0.4928595, 0.4999652, 0.5077294, 0.5162914, 0.5258452, 0.5366734,
  0.5426930, 0.5492125, 0.5563286, 0.5601460, 0.5641551, 0.5658144, 0.5675053, 0.5692268,
  0.5709762, 0.5727486, 0.5745353, 0.5763216, 0.5772077, 0.5780845, 0.5789480, 0.5793739,
  0.5797953, 0.5802121, 0.5802949, 0.5803775, 0.5804599, 0.5805421, 0.5806242, 0.5807876,
  0.5809502, 0.5810312, 0.5811120
};

const REAL imomegaqnm_l2m1[107] = {
  0.0833908, 0.0833925, 0.0833942, 0.0833976, 0.0834009, 0.0834026, 0.0834043, 0.0834060,
  0.0834077, 0.0834093, 0.0834177, 0.0834261, 0.0834345, 0.0834512, 0.0834679, 0.0834845,
  0.0835176, 0.0835506, 0.0835833, 0.0836159, 0.0836483, 0.0836806, 0.0837126, 0.0837921,
  0.0838704, 0.0840241, 0.0841737, 0.0843193, 0.0845994, 0.0848650, 0.0851170, 0.0853561,
  0.0855831, 0.0857987, 0.0860035, 0.0861980, 0.0863828, 0.0865584, 0.0867253, 0.0868840,
  0.0872470, 0.0875662, 0.0878462, 0.0880906, 0.0883025, 0.0884840, 0.0886370, 0.0887628,
  0.0888621, 0.0889354, 0.0889828, 0.0890037, 0.0889973, 0.0889623, 0.0888968, 0.0887983,
  0.0886636, 0.0884885, 0.0882679, 0.0879952, 0.0876618, 0.0872571, 0.0867670, 0.0861730,
  0.0854501, 0.0845642, 0.0834665, 0.0820852, 0.0814304, 0.0807035, 0.0798926, 0.0789827,
  0.0779550, 0.0767847, 0.0754394, 0.0738744, 0.0720270, 0.0698043, 0.0670610, 0.0635492,
  0.0613721, 0.0587910, 0.0556436, 0.0537759, 0.0516427, 0.0506978, 0.0496908, 0.0486136,
  0.0474565, 0.0462084, 0.0448564, 0.0433879, 0.0426068, 0.0417939, 0.0409502, 0.0405173,
  0.0400776, 0.0396313, 0.0395413, 0.0394510, 0.0393605, 0.0392697, 0.0391787, 0.0389959,
  0.0388122, 0.0387200, 0.0386275
};

const REAL reomegaqnm_l3m3[107] = {
  0.4638620, 0.4638713, 0.4638807, 0.4638994, 0.4639182, 0.4639275, 0.4639369, 0.4639463,
  0.4639556, 0.4639650, 0.4640118, 0.4640587, 0.4641056, 0.4641994, 0.4642932, 0.4643871,
  0.4645751, 0.4647632, 0.4649516, 0.4651403, 0.4653291, 0.4655181, 0.4657074, 0.4661816,
  0.4666572, 0.4676125, 0.4685735, 0.4695402, 0.4714910, 0.4734653, 0.4754638, 0.4774869,
  0.4795352, 0.4816091, 0.4837094, 0.4858366, 0.4879912, 0.4901740, 0.4923856, 0.4946267,
  0.5003630, 0.5062995, 0.5124492, 0.5188258, 0.5254448, 0.5323230, 0.5394792, 0.5469340,
  0.5547105, 0.5628344, 0.5713348, 0.5802442, 0.5895997, 0.5994433, 0.6098233, 0.6207956,
  0.6324249, 0.6447870, 0.6579717, 0.6720861, 0.6872595, 0.7036503, 0.7214547, 0.7409211,
  0.7623694, 0.7862227, 0.8130569, 0.8436869, 0.8572538, 0.8717171, 0.8872013, 0.9038599,
  0.9218848, 0.9415207, 0.9630876, 0.9870158, 1.0139059, 1.0446371, 1.0805826, 1.1240969,
  1.1499829, 1.1798616, 1.2154694, 1.2363668, 1.2602290, 1.2708577, 1.2822678, 1.2946159,
  1.3081175, 1.3230831, 1.3399911, 1.3596483, 1.3709442, 1.3836322, 1.3982863, 1.4066604,
  1.4160264, 1.4267910, 1.4291698, 1.4316425, 1.4342202, 1.4369166, 1.4397481, 1.4459063,
  1.4529527, 1.4569479, 1.4613898
};

const REAL imomegaqnm_l3m3[107] = {
  0.0909297, 0.0909301, 0.0909305, 0.0909312, 0.0909319, 0.0909323, 0.0909327, 0.0909330,
  0.0909334, 0.0909338, 0.0909356, 0.0909375, 0.0909393, 0.0909430, 0.0909466, 0.0909503,
  0.0909576, 0.0909650, 0.0909723, 0.0909796, 0.0909869, 0.0909942, 0.0910015, 0.0910197,
  0.0910378, 0.0910740, 0.0911100, 0.0911457, 0.0912166, 0.0912867, 0.0913560, 0.0914243,
  0.0914917, 0.0915582, 0.0916236, 0.0916880, 0.0917514, 0.0918136, 0.0918746, 0.0919344,
  0.0920784, 0.0922137, 0.0923394, 0.0924547, 0.0925583, 0.0926492, 0.0927258, 0.0927867,
  0.0928302, 0.0928541, 0.0928562, 0.0928338, 0.0927840, 0.0927030, 0.0925869, 0.0924305,
  0.0922281, 0.0919726, 0.0916556, 0.0912666, 0.0907928, 0.0902179, 0.0895213, 0.0886763,
  0.0876470, 0.0863849, 0.0848213, 0.0828557, 0.0819248, 0.0808922, 0.0797413, 0.0784512,
  0.0769953, 0.0753390, 0.0734361, 0.0712234, 0.0686106, 0.0654629, 0.0615646, 0.0565370,
  0.0533881, 0.0496087, 0.0449046, 0.0420439, 0.0386881, 0.0371631, 0.0355053, 0.0336873,
  0.0316714, 0.0294027, 0.0267968, 0.0237110, 0.0219107, 0.0198652, 0.0174725, 0.0160908,
  0.0145330, 0.0127266, 0.0123252, 0.0119070, 0.0114701, 0.0110120, 0.0105299, 0.0094773,
  0.0082662, 0.0075764, 0.0068068
};

const REAL reomegaqnm_l3m2[107] = {
  0.5136068, 0.5136120, 0.5136172, 0.5136277, 0.5136381, 0.5136433, 0.5136486, 0.5136538,
  0.5136590, 0.5136642, 0.5136904, 0.5137165, 0.5137426, 0.5137950, 0.5138473, 0.5138998,
  0.5140048, 0.5141100, 0.5142154, 0.5143210, 0.5144268, 0.5145327, 0.5146389, 0.5149053,
  0.5151728, 0.5157118, 0.5162557, 0.5168047, 0.5179181, 0.5190523, 0.5202076, 0.5213842,
  0.5225826, 0.5238031, 0.5250460, 0.5263118, 0.5276007, 0.5289131, 0.5302496, 0.5316104,
  0.5351221, 0.5387961, 0.5426403, 0.5466633, 0.5508747, 0.5552848, 0.5599054, 0.5647494,
  0.5698311, 0.5751666, 0.5807739, 0.5866734, 0.5928879, 0.5994433, 0.6063693, 0.6137000,
  0.6214745, 0.6297385, 0.6385453, 0.6479581, 0.6580522, 0.6689185, 0.6806685, 0.6934404,
  0.7074094, 0.7228020, 0.7399192, 0.7591747, 0.7676002, 0.7765087, 0.7859588, 0.7960213,
  0.8067828, 0.8183509, 0.8308625, 0.8444960, 0.8594910, 0.8761828, 0.8950661, 0.9169286,
  0.9293747, 0.9431793, 0.9587794, 0.9674662, 0.9769240, 0.9809677, 0.9851861, 0.9896014,
  0.9942412, 0.9991404, 1.0043432, 1.0099068, 1.0128449, 1.0158985, 1.0190705, 1.0206974,
  1.0223442, 1.0239961, 1.0243248, 1.0246521, 1.0249777, 1.0253010, 1.0256214, 1.0262513,
  1.0268617, 1.0271582, 1.0274485
};

const REAL imomegaqnm_l3m2[107] = {
  0.0892015, 0.0892023, 0.0892032, 0.0892048, 0.0892064, 0.0892072, 0.0892080, 0.0892089,
  0.0892097, 0.0892105, 0.0892146, 0.0892186, 0.0892227, 0.0892308, 0.0892390, 0.0892471,
  0.0892632, 0.0892794, 0.0892954, 0.0893115, 0.0893275, 0.0893434, 0.0893593, 0.0893988,
  0.0894380, 0.0895156, 0.0895921, 0.0896674, 0.0898147, 0.0899577, 0.0900965, 0.0902312,
  0.0903618, 0.0904885, 0.0906114, 0.0907305, 0.0908460, 0.0909578, 0.0910661, 0.0911709,
  0.0914181, 0.0916444, 0.0918505, 0.0920366, 0.0922029, 0.0923491, 0.0924750, 0.0925799,
  0.0926631, 0.0927235, 0.0927597, 0.0927698, 0.0927518, 0.0927030, 0.0926202, 0.0924995,
  0.0923361, 0.0921243, 0.0918568, 0.0915248, 0.0911173, 0.0906203, 0.0900158, 0.0892804,
  0.0883827, 0.0872800, 0.0859118, 0.0841896, 0.0833733, 0.0824675, 0.0814574, 0.0803247,
  0.0790459, 0.0775905, 0.0759179, 0.0739724, 0.0716744, 0.0689047, 0.0654729, 0.0610437,
  0.0582675, 0.0549333, 0.0507808, 0.0482550, 0.0452930, 0.0439479, 0.0424869, 0.0408868,
  0.0391161, 0.0371298, 0.0348608, 0.0322004, 0.0306680, 0.0289521, 0.0269932, 0.0258946,
  0.0246950, 0.0233727, 0.0230914, 0.0228039, 0.0225103, 0.0222104, 0.0219040, 0.0212725,
  0.0206181, 0.0202839, 0.0199461
};

const REAL reomegaqnm_l4m4[107] = {
  0.6208855, 0.6208986, 0.6209116, 0.6209377, 0.6209638, 0.6209769, 0.6209899, 0.6210030,
  0.6210160, 0.6210291, 0.6210944, 0.6211597, 0.6212251, 0.6213558, 0.6214866, 0.6216175,
  0.6218794, 0.6221417, 0.6224043, 0.6226672, 0.6229304, 0.6231939, 0.6234577, 0.6241186,
  0.6247814, 0.6261129, 0.6274522, 0.6287994, 0.6315179, 0.6342691, 0.6370537, 0.6398724,
  0.6427259, 0.6456151, 0.6485406, 0.6515033, 0.6545040, 0.6575436, 0.6606230, 0.6637431,
  0.6717278, 0.6799888, 0.6885434, 0.6974107, 0.7066113, 0.7161682, 0.7261067, 0.7364547,
  0.7472435, 0.7585077, 0.7702864, 0.7826235, 0.7955686, 0.8091784, 0.8235174, 0.8386602,
  0.8546934, 0.8717180, 0.8898534, 0.9092417, 0.9300542, 0.9525002, 0.9768386, 1.0033960,
  1.0325924, 1.0649814, 1.1013150, 1.1426539, 1.1609185, 1.1803590, 1.2011367, 1.2234501,
  1.2475470, 1.2737433, 1.3024512, 1.3342248, 1.3698366, 1.4104161, 1.4577259, 1.5147847,
  1.5486233, 1.5875890, 1.6339033, 1.6610247, 1.6919428, 1.7056972, 1.7204516, 1.7364058,
  1.7538351, 1.7731363, 1.7949202, 1.8202172, 1.8347400, 1.8510412, 1.8698529, 1.8805957,
  1.8926049, 1.9063997, 1.9094469, 1.9126140, 1.9159152, 1.9193678, 1.9229929, 1.9308751,
  1.9398909, 1.9450012, 1.9506815
};

const REAL imomegaqnm_l4m4[107] = {
  0.0917882, 0.0917886, 0.0917890, 0.0917898, 0.0917907, 0.0917911, 0.0917915, 0.0917919,
  0.0917923, 0.0917928, 0.0917948, 0.0917969, 0.0917990, 0.0918032, 0.0918073, 0.0918115,
  0.0918198, 0.0918281, 0.0918364, 0.0918447, 0.0918530, 0.0918613, 0.0918696, 0.0918903,
  0.0919109, 0.0919521, 0.0919931, 0.0920340, 0.0921151, 0.0921956, 0.0922753, 0.0923543,
  0.0924324, 0.0925097, 0.0925861, 0.0926616, 0.0927361, 0.0928096, 0.0928821, 0.0929535,
  0.0931268, 0.0932920, 0.0934484, 0.0935949, 0.0937302, 0.0938532, 0.0939623, 0.0940559,
  0.0941321, 0.0941887, 0.0942233, 0.0942330, 0.0942145, 0.0941640, 0.0940768, 0.0939478,
  0.0937705, 0.0935374, 0.0932393, 0.0928650, 0.0924006, 0.0918287, 0.0911274, 0.0902679,
  0.0892124, 0.0879094, 0.0862870, 0.0842401, 0.0832692, 0.0821917, 0.0809905, 0.0796442,
  0.0781255, 0.0763992, 0.0744185, 0.0721192, 0.0694103, 0.0661560, 0.0621396, 0.0569820,
  0.0537633, 0.0499111, 0.0451315, 0.0422323, 0.0388376, 0.0372970, 0.0356236, 0.0337901,
  0.0317587, 0.0294747, 0.0268536, 0.0237529, 0.0219453, 0.0198926, 0.0174928, 0.0161075,
  0.0145463, 0.0127365, 0.0123344, 0.0119155, 0.0114779, 0.0110192, 0.0105364, 0.0094825,
  0.0082701, 0.0075796, 0.0068093
};

const REAL reomegaqnm_l4m3[107] = {
  0.6693002, 0.6693096, 0.6693190, 0.6693378, 0.6693566, 0.6693660, 0.6693754, 0.6693847,
  0.6693941, 0.6694035, 0.6694505, 0.6694975, 0.6695445, 0.6696385, 0.6697326, 0.6698268,
  0.6700154, 0.6702042, 0.6703932, 0.6705825, 0.6707721, 0.6709619, 0.6711520, 0.6716283,
  0.6721062, 0.6730669, 0.6740342, 0.6750081, 0.6769759, 0.6789709, 0.6809934, 0.6830442,
  0.6851236, 0.6872322, 0.6893706, 0.6915394, 0.6937392, 0.6959706, 0.6982341, 0.7005306,
  0.7064203, 0.7125313, 0.7188760, 0.7254679, 0.7323219, 0.7394544, 0.7468833, 0.7546284,
  0.7627120, 0.7711586, 0.7799957, 0.7892540, 0.7989685, 0.8091784, 0.8199287, 0.8312708,
  0.8432641, 0.8559777, 0.8694922, 0.8839034, 0.8993256, 0.9158968, 0.9337868, 0.9532065,
  0.9744241, 0.9977881, 1.0237636, 1.0529941, 1.0657927, 1.0793335, 1.0937094, 1.1090333,
  1.1254440, 1.1431159, 1.1622721, 1.1832067, 1.2063199, 1.2321809, 1.2616477, 1.2961279,
  1.3159845, 1.3382581, 1.3638397, 1.3783313, 1.3943722, 1.4013335, 1.4086742, 1.4164577,
  1.4247680, 1.4337213, 1.4434874, 1.4543344, 1.4602984, 1.4667410, 1.4738122, 1.4776577,
  1.4817735, 1.4862381, 1.4871830, 1.4881482, 1.4891354, 1.4901463, 1.4911833, 1.4933459,
  1.4956504, 1.4968674, 1.4981358
};

const REAL imomegaqnm_l4m3[107] = {
  0.0909037, 0.0909044, 0.0909050, 0.0909063, 0.0909076, 0.0909082, 0.0909088, 0.0909095,
  0.0909101, 0.0909107, 0.0909139, 0.0909171, 0.0909203, 0.0909267, 0.0909330, 0.0909394,
  0.0909520, 0.0909647, 0.0909773, 0.0909899, 0.0910025, 0.0910151, 0.0910276, 0.0910588,
  0.0910899, 0.0911517, 0.0912128, 0.0912734, 0.0913929, 0.0915100, 0.0916249, 0.0917376,
  0.0918480, 0.0919562, 0.0920622, 0.0921659, 0.0922675, 0.0923668, 0.0924639, 0.0925588,
  0.0927862, 0.0929995, 0.0931982, 0.0933819, 0.0935500, 0.0937018, 0.0938363, 0.0939523,
  0.0940485, 0.0941233, 0.0941747, 0.0942005, 0.0941980, 0.0941640, 0.0940946, 0.0939853,
  0.0938306, 0.0936239, 0.0933572, 0.0930204, 0.0926012, 0.0920840, 0.0914489, 0.0906697,
  0.0897120, 0.0885284, 0.0870525, 0.0851868, 0.0843003, 0.0833153, 0.0822157, 0.0809813,
  0.0795864, 0.0779977, 0.0761705, 0.0740437, 0.0715299, 0.0684982, 0.0647384, 0.0598795,
  0.0568286, 0.0531572, 0.0485691, 0.0457669, 0.0424659, 0.0409602, 0.0393191, 0.0375140,
  0.0355050, 0.0332342, 0.0306118, 0.0274846, 0.0256483, 0.0235503, 0.0210793, 0.0196436,
  0.0180169, 0.0161197, 0.0156964, 0.0152549, 0.0147930, 0.0143081, 0.0137968, 0.0126782,
  0.0113876, 0.0106515, 0.0098303
};

const REAL reomegaqnm_l5m5[107] = {
  0.7722084, 0.7722250, 0.7722417, 0.7722749, 0.7723082, 0.7723249, 0.7723415, 0.7723582,
  0.7723748, 0.7723915, 0.7724747, 0.7725580, 0.7726413, 0.7728080, 0.7729748, 0.7731417,
  0.7734757, 0.7738101, 0.7741450, 0.7744802, 0.7748158, 0.7751518, 0.7754882, 0.7763309,
  0.7771760, 0.7788738, 0.7805816, 0.7822995, 0.7857661, 0.7892744, 0.7928254, 0.7964199,
  0.8000589, 0.8037434, 0.8074743, 0.8112526, 0.8150796, 0.8189561, 0.8228834, 0.8268627,
  0.8370462, 0.8475822, 0.8584928, 0.8698019, 0.8815359, 0.8937240, 0.9063981, 0.9195938,
  0.9333504, 0.9477121, 0.9627282, 0.9784541, 0.9949527, 1.0122953, 1.0305636, 1.0498516,
  1.0702682, 1.0919408, 1.1150193, 1.1396824, 1.1661450, 1.1946693, 1.2255796, 1.2592842,
  1.2963072, 1.3373388, 1.3833150, 1.4355536, 1.4586087, 1.4831307, 1.5093194, 1.5374201,
  1.5677389, 1.6006659, 1.6367095, 1.6765525, 1.7211460, 1.7718796, 1.8309191, 1.9019707,
  1.9440292, 1.9923892, 2.0497724, 2.0833279, 2.1215386, 2.1385229, 2.1567324, 2.1764117,
  2.1978974, 2.2216752, 2.2484920, 2.2796080, 2.2974594, 2.3174862, 2.3405839, 2.3537678,
  2.3685004, 2.3854164, 2.3891520, 2.3930343, 2.3970805, 2.4013118, 2.4057540, 2.4154112,
  2.4264542, 2.4327123, 2.4396670
};

const REAL imomegaqnm_l5m5[107] = {
  0.0921596, 0.0921600, 0.0921605, 0.0921613, 0.0921622, 0.0921627, 0.0921631, 0.0921635,
  0.0921640, 0.0921644, 0.0921666, 0.0921688, 0.0921711, 0.0921755, 0.0921799, 0.0921843,
  0.0921931, 0.0922019, 0.0922107, 0.0922195, 0.0922283, 0.0922371, 0.0922459, 0.0922679,
  0.0922898, 0.0923335, 0.0923770, 0.0924205, 0.0925068, 0.0925926, 0.0926777, 0.0927620,
  0.0928457, 0.0929286, 0.0930106, 0.0930918, 0.0931722, 0.0932516, 0.0933300, 0.0934074,
  0.0935961, 0.0937773, 0.0939500, 0.0941133, 0.0942660, 0.0944066, 0.0945339, 0.0946460,
  0.0947411, 0.0948169, 0.0948709, 0.0949002, 0.0949014, 0.0948705, 0.0948030, 0.0946932,
  0.0945348, 0.0943198, 0.0940389, 0.0936804, 0.0932301, 0.0926700, 0.0919774, 0.0911228,
  0.0900671, 0.0887575, 0.0871199, 0.0850466, 0.0840612, 0.0829665, 0.0817451, 0.0803751,
  0.0788289, 0.0770706, 0.0750526, 0.0727103, 0.0699513, 0.0666388, 0.0625545, 0.0573174,
  0.0540540, 0.0501531, 0.0453206, 0.0423931, 0.0389690, 0.0374162, 0.0357305, 0.0338844,
  0.0318402, 0.0295431, 0.0269089, 0.0237947, 0.0219803, 0.0199207, 0.0175140, 0.0161252,
  0.0145605, 0.0127472, 0.0123443, 0.0119247, 0.0114865, 0.0110270, 0.0105435, 0.0094882,
  0.0082744, 0.0075832, 0.0068122
};

gsl_spline *spline = gsl_spline_alloc(gsl_interp_cspline, 107);
if (spline == NULL){
  fprintf(stderr,"Error: in SEOBNRv5_aligned_spin_coefficients(), gsl_spline_alloc failed to initialize\\n");
  exit(EXIT_FAILURE);
}
gsl_interp_accel *acc = gsl_interp_accel_alloc();
if (acc == NULL){
  fprintf(stderr,"Error: in SEOBNRv5_aligned_spin_coefficients(), gsl_interp_accel_alloc failed to initialize\\n");
  gsl_spline_free(spline); // Clean up the first allocation
  exit(EXIT_FAILURE);
}

const REAL a_f_clamped = (commondata->a_f < afinallist[0]) ? afinallist[0] :
                      ((commondata->a_f > afinallist[106]) ? afinallist[106] : commondata->a_f);

#define EVAL_QNM(L, M, TARGET_OMEGA, TARGET_TAU, RE_ARRAY, IM_ARRAY) do { \\
    gsl_spline_init(spline, afinallist, RE_ARRAY, 107); \\
    gsl_interp_accel_reset(acc); \\
    commondata->TARGET_OMEGA = gsl_spline_eval(spline, a_f_clamped, acc) / commondata->M_f; \\
    gsl_spline_init(spline, afinallist, IM_ARRAY, 107); \\
    gsl_interp_accel_reset(acc); \\
    commondata->TARGET_TAU = 1. / (gsl_spline_eval(spline, a_f_clamped, acc) / commondata->M_f); \\
} while(0)

EVAL_QNM(2, 2, omega_qnm_l2m2, tau_qnm_l2m2, reomegaqnm_l2m2, imomegaqnm_l2m2);
EVAL_QNM(2, 1, omega_qnm_l2m1, tau_qnm_l2m1, reomegaqnm_l2m1, imomegaqnm_l2m1);
EVAL_QNM(3, 3, omega_qnm_l3m3, tau_qnm_l3m3, reomegaqnm_l3m3, imomegaqnm_l3m3);
EVAL_QNM(3, 2, omega_qnm_l3m2, tau_qnm_l3m2, reomegaqnm_l3m2, imomegaqnm_l3m2);
EVAL_QNM(4, 4, omega_qnm_l4m4, tau_qnm_l4m4, reomegaqnm_l4m4, imomegaqnm_l4m4);
EVAL_QNM(4, 3, omega_qnm_l4m3, tau_qnm_l4m3, reomegaqnm_l4m3, imomegaqnm_l4m3);
EVAL_QNM(5, 5, omega_qnm_l5m5, tau_qnm_l5m5, reomegaqnm_l5m5, imomegaqnm_l5m5);

commondata->omega_qnm = commondata->omega_qnm_l2m2;
commondata->tau_qnm   = commondata->tau_qnm_l2m2;

gsl_spline_free(spline);
gsl_interp_accel_free(acc);
"""
    cfc.register_CFunction(
        includes=includes,
        desc=desc,
        cfunc_type=cfunc_type,
        name=name,
        params=params,
        body=body,
    )
    return pcg.NRPyEnv()
